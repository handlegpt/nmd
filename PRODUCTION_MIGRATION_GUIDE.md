# 生产环境用户数据迁移指南

## 📋 迁移准备清单

### ✅ 已完成
- [x] 数据库表结构创建 (`user_preferences`)
- [x] 迁移工具开发 (`migrateUserPreferences.ts`)
- [x] 迁移UI组件 (`UserPreferencesMigration.tsx`)
- [x] 代码清理 (移除 localStorage 依赖)
- [x] 系统测试验证

### 🚀 生产环境部署步骤

#### 1. 数据库部署
```sql
-- 在生产环境 Supabase 中执行
-- 使用 database/migrate_user_preferences_data_en.sql 脚本
```

#### 2. 应用部署
- 部署包含迁移系统的新版本代码
- 确保环境变量正确配置
- 验证数据库连接

#### 3. 用户数据迁移流程

##### 自动迁移 (推荐)
- 用户登录时自动检测 localStorage 数据
- 显示迁移提示，用户确认后自动迁移
- 迁移完成后清理 localStorage

##### 手动迁移 (备用)
- 管理员可以通过 `/test-migration` 页面手动迁移
- 批量处理用户数据

#### 4. 迁移监控
- 监控迁移成功率
- 记录迁移日志
- 处理迁移失败的用户

## 🛡️ 安全措施

### 数据备份
```sql
-- 迁移前备份
CREATE TABLE user_preferences_backup_$(date +%Y%m%d) AS 
SELECT * FROM user_preferences;
```

### 回滚计划
- 保留 localStorage 数据作为备份
- 数据库回滚脚本准备
- 应用版本回滚方案

## 📊 迁移统计

### 预期数据量
- 真实用户数量: 待统计
- 需要迁移的数据类型:
  - 用户收藏列表 (`nomadFavorites`)
  - 隐藏用户列表 (`hidden_nomad_users`)

### 性能考虑
- 分批处理用户数据
- 异步迁移避免阻塞用户操作
- 数据库连接池优化

## 🔧 故障处理

### 常见问题
1. **迁移失败**: 自动重试机制
2. **数据冲突**: 优先使用数据库数据
3. **网络问题**: 离线模式支持

### 支持流程
1. 用户报告问题
2. 检查迁移日志
3. 手动修复数据
4. 验证修复结果

## 📈 成功指标

- 迁移成功率 > 95%
- 用户投诉 < 1%
- 系统性能无显著下降
- 数据完整性 100%

## 🎯 后续优化

- 添加更多用户偏好字段
- 实现数据同步功能
- 优化迁移性能
- 增强错误处理
